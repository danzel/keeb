units:
  # Proxy Spacing Variables (choc)
  kx: cx
  ky: cy
  # Default visuals look like choc
  $default_width: cx
  $default_height: cy
  # choc switch Variables
  # ref https://github.com/josefadamcik/SofleKeyboard/issues/136#issuecomment-1043234757
  choc_grip_thickness: 1.2 # 1.3, but 1.2 seems perfect?
  choc_thick_thickness: 2.2 # From top of grip area to bottom flat area (above the legs)
  choc_leg_thickness: 2.65
  # How far to pad out the plate from keycap edges. Walls go around this
  px: kx + 0
  py: ky + 0
  # Bottom base - This will have .15 layer height
  # Layer height decided because of the choc leg thickness.
  # If .75 bottom thickness is too much we could look at another number
  # Note that the legs are shorter than the wire legs on the switches, so those will need to be trimmed
  case_layer_height: 0.2
  bottom_layer_height: 0.15
  bottom_thickness: 0.75
  bottom_thickness_in_wall: 1.8 # needs to be divisible by .15 (base layer height) and .2 (case layer height)
  # Wall around outside of case
  wall_width: 2
  wall_width_inset: 1  # with at the bottom, allowing some overlap with the base
  wall_thickness: choc_thick_thickness + choc_leg_thickness + bottom_thickness
  wall_thickness_inset: wall_thickness - bottom_thickness_in_wall
  # Pi Pico Variables
  pico_w: 21
  pico_h: 51
  pico_hole_offset_x: 4.8
  pico_hole_offset_y: 2
  pico_hole_diameter: 2.1
  pico_hole_clearance_diameter: 3.8
  pico_hole_x_distance: pico_w - 2 * pico_hole_offset_x
  pico_hole_y_distance: pico_h - 2 * pico_hole_offset_y
  pico_usb_thickness: 2.63 # above pcb
  pico_usb_thickness_into_pcb: .4
  pico_usb_width: 8.2 # Rounded up from 8
  pico_usb_height_on_pcb: 4.3 + .3 # Measured as 4.3
  pico_pcb_thickness: 1
  # Where the reset button is from the edge of the PCB, roughly measured in freecad
  pico_reset_x: 5.4 - 0.3 #5.4
  pico_reset_y: 9.87 - 0.3 #9.87
  pico_reset_width: 3.2 + 0.6 # 3.2
  pico_reset_height: 4.25 + 0.6 # 4.25
  # Pi Pico related numbers
  # the tallest component on the pico other than the reset button and USB is 1.25mm high, round that up to nearest .2 (case layer height)
  pico_thickness_above_gap: 1.4 # ^^
  pico_left_gap: 1 # How far left to move from the top left of the flat box
  pico_top_gap: 0 # TODO: May need some top padding
  #Misc
  link_cable_hole_size: 3.4
  #Clip for holding sides together
  clip_wall_cut: wall_width - wall_width_inset
  clip_wall_inset: 1
  clip_wall_length: 5
  # Thumb Variables
  thumbsplay: -13
points:
  zones:
    matrix:
      key:
        padding: 1ky
        spread: 1kx
      columns:
        pinky:
        ring:
          key.stagger: 21
        middle:
          key.stagger: 8
        index:
          key.stagger: -8
        inner:
          key.stagger: -3
      rows:
        bottom:
        home:
        top:
    thumbfan:
      anchor:
        ref: matrix_inner_bottom
        shift: [2, -23]
      columns:
        near:
          key.splay: thumbsplay - 4
        home:
          key.spread: 19.25
          key.splay: thumbsplay
          key.origin: [-9.5, -6]
        far:
          key.spread: 19.25
          key.splay: thumbsplay
          key.origin: [-9.5, -6]
      rows:
        thumb:
outlines:
  keycaps:
  # Just for testing
  - what: rectangle
    where: true
    size: [kx, ky]
    corner: 1
  border:
    # Trace around the outside of the keys
    - what: polygon
      operation: stack
      points:
        - ref: matrix_pinky_top
          shift: [-.5px, .5py]
        - ref: matrix_ring_top
          shift: [-.5px, .5py]
        - ref: matrix_middle_top
          shift: [-.5px, .5py]
        - ref: matrix_middle_top
          shift: [.5px, .5py]
        - ref: matrix_index_top
          shift: [.5px, .5py]
        - ref: matrix_inner_top
          shift: [.5px, .5py]
        # Add space for the pi pico
        - ref: matrix_inner_top
          shift: [.5px + pico_w + 3, .5py]
        - ref: matrix_inner_top
          shift: [.5px + pico_w + 3, .5py - pico_h - 19]
        # End of space
        - ref: thumbfan_far_thumb
          shift: [.5px, .5py]
        - ref: thumbfan_far_thumb
          shift: [.5px, -.5py]
        - ref: thumbfan_far_thumb
          shift: [-.5px, -.5py]
        - ref: thumbfan_near_thumb
          shift: [.5px, -.5py]
        - ref: thumbfan_near_thumb
          shift: [-.5px, -.5py]
        - ref: matrix_pinky_bottom
          shift: [-.5px, -.5py]
  _border_plus_wall:
    - what: outline
      name: border
      expand: wall_width
  _border_plus_wall_inset:
    - what: outline
      name: border
      expand: wall_width_inset
  holes:
  #holes that the switches fit through
    - what: rectangle
      where: true
      size: [13.8, 13.8]
  wideholes:
  #holes the switches and clips fit through, used to make the plate thicker where it can be
    - what: rectangle
      where: true
      size: [14.7, 13.8]
  _pico_posts_template:
    #Template for the location that the posts to mount the pico
    #Template because we want to use this multiple times with different radius
    $params: [__r__]
    top_left:
      what: circle
      adjust:
        ref: matrix_inner_top
        shift: [.5px + pico_left_gap + pico_hole_offset_x, .5py - pico_hole_offset_y - pico_top_gap]
      radius: __r__
    top_right:
      what: circle
      adjust:
        ref: matrix_inner_top
        shift: [0.5px + pico_left_gap + pico_hole_offset_x + pico_hole_x_distance, .5py - pico_hole_offset_y - pico_top_gap]
      radius: __r__
    bottom_left:
      what: circle
      adjust:
        ref: matrix_inner_top
        shift: [.5px + pico_left_gap + pico_hole_offset_x, .5py - pico_hole_offset_y - pico_top_gap - pico_hole_y_distance]
      radius: __r__
    bottom_right:
      what: circle
      adjust:
        ref: matrix_inner_top
        shift: [.5px + pico_left_gap + pico_hole_offset_x + pico_hole_x_distance, .5py - pico_hole_offset_y - pico_top_gap - pico_hole_y_distance]
      radius: __r__
  pico_mounting_posts:
    $extends: outlines._pico_posts_template
    $args: [pico_hole_diameter/2]
  pico_mounting_supports:
    $extends: outlines._pico_posts_template
    $args: [pico_hole_clearance_diameter/2]
  pico_usb_hole:
    #hole for where the usb port comes through the case
    - what: rectangle
      size: [pico_usb_width, pico_usb_height_on_pcb + pico_top_gap + wall_width]
      adjust:
        ref: matrix_inner_top
        shift: [.5px + pico_left_gap + pico_w / 2, .5py - sy/2 + wall_width]
  pico_reset_hole:
    #hole for where the reset button comes through the case
    #TODO: Can't mirror this part because the hole isn't centered on the PCB, will need another case for it
    - what: rectangle
      size: [pico_reset_width, pico_reset_height]
      adjust:
        ref: matrix_inner_top
        shift: [.5px + pico_left_gap + pico_reset_x + sx/2, .5py - pico_top_gap - pico_reset_y - sy/2]
  link_cable_hole:
    # Size is measured off a random usb mini cable
    # Positioned near the bottom of the long inner wall
    - what: rectangle
      size: [wall_width + 5, link_cable_hole_size]
      adjust:
        ref: matrix_inner_top
        shift: [.5px + pico_w + 3 + wall_width - sx/2, .5py - pico_h - 7]
  clip_walls_cut:
    # Inner top (next to pico)
    - what: rectangle
      size: [clip_wall_cut, clip_wall_length]
      adjust:
        ref: matrix_inner_top
        shift: [.5px + pico_w + 3 + wall_width_inset + clip_wall_cut/2, .5py - 10]
    # Inner bottom (below link cable hole)
    - what: rectangle
      size: [clip_wall_cut, clip_wall_length]
      adjust:
        ref: matrix_inner_top
        shift: [.5px + pico_w + 3 + wall_width_inset + clip_wall_cut/2, .5py - pico_h - 14]
    # Outer top
    - what: rectangle
      size: [clip_wall_cut, clip_wall_length]
      adjust:
        ref: matrix_pinky_top
        shift: [-.5px - wall_width_inset - clip_wall_cut/2, .5py - 8]
    # Outer bottom
    - what: rectangle
      size: [clip_wall_cut, clip_wall_length]
      adjust:
        ref: matrix_pinky_top
        shift: [-.5px - wall_width_inset - clip_wall_cut/2, .5py - 44]
  clip_plate_cut:
    #TODO: There is a good chance the math in here is wrong but it works because variables are the same
    # Inner top (next to pico)
    - what: rectangle
      size: [wall_width + clip_wall_inset, clip_wall_length]
      adjust:
        ref: matrix_inner_top
        shift: [.5px + pico_w + 3 + clip_wall_inset/2, .5py - 10]
    # Inner bottom (below link cable hole)
    - what: rectangle
      size: [wall_width + clip_wall_inset, clip_wall_length]
      adjust:
        ref: matrix_inner_top
        shift: [.5px + pico_w + 3 + clip_wall_inset/2, .5py - pico_h - 14]
    # Outer top
    - what: rectangle
      size: [wall_width + clip_wall_inset, clip_wall_length]
      adjust:
        ref: matrix_pinky_top
        shift: [-.5px - wall_width_inset + clip_wall_inset/2, .5py - 8]
    # Outer bottom
    - what: rectangle
      size: [wall_width + clip_wall_inset, clip_wall_length]
      adjust:
        ref: matrix_pinky_top
        shift: [-.5px - wall_width_inset + clip_wall_inset/2, .5py - 44]
  plate:
    - "border"
    - "-holes"
  platethickener:
    - "border"
    - "-wideholes"
  wall:
    - "_border_plus_wall"
    - "-border"
  wall_inset:
    - "_border_plus_wall_inset"
    - "-border"
  wall_outside_inset:
    - "_border_plus_wall"
    - "-_border_plus_wall_inset"
  case_pico_holes:
    - "pico_usb_hole"
    - "pico_reset_hole"
cases:
  plate:
    # Plate that switches clip in to + thicker at areas it can be
    - name: plate
      extrude: choc_grip_thickness
    - name: platethickener
      extrude: choc_thick_thickness

    # Wall around the plate, less thick in inset area
    - name: wall
      extrude: wall_thickness_inset
    - name: wall_outside_inset
      extrude: wall_thickness

    # Mounting poles for the pico
    - name: pico_mounting_supports
      extrude: choc_thick_thickness + pico_thickness_above_gap
    - name: pico_mounting_posts
      extrude: wall_thickness - case_layer_height # Reduced a bit because the matching piece isn't quite tall enough (0.1mm short) based on the layer height

    # Holes for pico bits to pop through (USB, Reset)
    - name: case_pico_holes
      extrude: choc_thick_thickness + pico_thickness_above_gap + pico_usb_thickness_into_pcb
      operation: subtract 

    # Hole for link cable (Remove the hole then add back the plate above it)
    - name: link_cable_hole
      extrude: choc_grip_thickness + link_cable_hole_size
      operation: subtract
    - name: link_cable_hole
      extrude: choc_grip_thickness

    # Holes for case closer clips
    - name: clip_walls_cut
      extrude: wall_thickness
      operation: subtract
    - name: clip_plate_cut
      extrude: choc_thick_thickness
      operation: subtract
  base:
    # Base of the case
    - name: border
      extrude: bottom_thickness

    # Wall around the plate, goes inside the outer wall of the case
    - name: wall_inset
      extrude: bottom_thickness_in_wall
    
    # Bottom pole support for pico
    - name: pico_mounting_supports
      extrude: wall_thickness - choc_thick_thickness - pico_thickness_above_gap - pico_pcb_thickness
    # Hole where the pico posts come in
    - name: pico_mounting_posts
      extrude: wall_thickness - choc_thick_thickness - pico_thickness_above_gap - pico_pcb_thickness
      operation: subtract

    # TODO link cable??

    # Holes for case closer clips
    - name: clip_walls_cut
      extrude: wall_thickness
      operation: subtract
    - name: clip_plate_cut
      extrude: bottom_thickness
      operation: subtract
